@page
@model AnnouncementRazorPages.Pages.DetailsModel
@{
    ViewData["Title"] = "Announcement Details";
}

<h1>Announcement Details</h1>

<hr />
<dl class="row">
    <dt class="col-sm-2">
        @Html.HiddenFor(model => model.Announcements.Id)
        @Html.DisplayNameFor(model => model.Announcements.Title)
    </dt>
    <dd class="col-sm-10">
        @Html.DisplayFor(model => model.Announcements.Title)
    </dd>
    <dt class="col-sm-2">
        @Html.DisplayNameFor(model => model.Announcements.Desciption)
    </dt>
    <dd class="col-sm-10">
        @Html.DisplayFor(model => model.Announcements.Desciption)
    </dd>
    <dt class="col-sm-2">
        @Html.DisplayNameFor(model => model.Announcements.CreatedBy)
    </dt>
    <dd class="col-sm-10">
        @Html.DisplayFor(model => model.Announcements.CreatedBy)
    </dd>
    <dt class="col-sm-2">
        @Html.DisplayNameFor(model => model.Announcements.CreatedAt)
    </dt>
    <dd class="col-sm-10">
        @Html.DisplayFor(model => model.Announcements.CreatedAt)
    </dd>
    @*<dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.UpdateAt)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.UpdateAt)
        </dd>*@
</dl>

<div class="row mb-2">
    <div class="col-md-12">
        <a href="#" id="commentBtn">Add a comment</a>
    </div>
</div>

<div class="row mb-2" id="commentBox" style="display:none">
    <div class="col-md-12">

        <div class="form-group row">
            <input type="text" class="col-sm-8 col-form-label" id="description" asp-for="Comment.Description" placeholder="write a comment">
            <input type="hidden" id="announcementsId" asp-for="Comment.AnnouncementsId" value="@Model.Announcements.Id">
            <div class="col-sm-2">
                <button type="button" id="btnGet" class="btn btn-primary">Add Comment</button>
            </div>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-md-12" id="comments">
        @*@foreach (var comment in Model.Comments)
            {
                <p>
                    @comment.Description
                    @comment.SenderId
                </p>
            }*@
    </div>
</div>
@section Scripts
{
    <script>
        $(document).ready(function () {
            getComments();
            $("#commentBtn").click(function () {
                $("#commentBox").show();
            });
            $("#btnGet").click(function () {
                $.ajax({
                    url: "/Details?handler=Comment",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("XSRF-TOKEN",
                            $('input:hidden[name="__RequestVerificationToken"]').val());
                    },
                    type: "POST",
                    data: { "description": $("#description").val(), "announcementsId": $("#announcementsId").val() },
                    success: function (response) {
                        $('#comments').empty();
                        getComments();
                    },
                    failure: function (response) {
                        alert(response.responseText);
                    },
                    error: function (response) {
                        alert(response.responseText);
                    }
                });
                $("#description").val("");
            });

            function getComments() {
                var announcementsId = $("#Announcements_Id").val();
                $.ajax({
                    url: `/Details?id=${announcementsId}&&handler=Comments`,
                    type: "GET",
                    success: function (response) {
                        $.each(response, function (index, value) {
                            $('#comments').append(`<ul class="list-group list-group-flush">
                                                                                    <li class="list-group-item ${value.id}">
                                                                                          <small class="text-muted">${value.sender.userName}: </small>
                                                                                          <span>${value.description}</span>

                                                                                        </li></ul>`);
                            getCommentById(value.id);
                        })
                    },
                    failure: function (response) {
                        alert(response.responseText);
                    },
                    error: function (response) {
                        alert(response.responseText);
                    }
                });
            }
            function getCommentById(id) {
                $.ajax({
                    url: `/Details?id=${id}&&handler=CommentById`,
                    type: "GET",
                    success: function (response) {
                        $.each(response, function (index, value) {
                            $(`.${id}`).append(`
                                                                                    <li class="list-group-item ${value.id}">
                                                                                          <small class="text-muted">${value.sender.userName}: </small>
                                                                                          <span>${value.description}</span>

                                                                                        </li>`);
                        })
                    },
                    failure: function (response) {
                        console.log(response);
                    },
                    error: function (response) {
                        console.log(response);
                    }
                });
            }
        });
    </script>
}